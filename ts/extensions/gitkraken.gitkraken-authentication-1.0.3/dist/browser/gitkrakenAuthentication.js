(()=>{"use strict";var d={};d.d=(e,t)=>{for(var n in t)d.o(t,n)&&!d.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},d.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),d.r=e=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var $={};d.r($),d.d($,{activate:()=>lt});const r=require("vscode");var w,G=new Uint8Array(16);function R(){if(!w&&(w=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!w))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return w(G)}const j=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function H(e){return typeof e=="string"&&j.test(e)}const K=H;for(var g=[],C=0;C<256;++C)g.push((C+256).toString(16).substr(1));function M(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=(g[e[t+0]]+g[e[t+1]]+g[e[t+2]]+g[e[t+3]]+"-"+g[e[t+4]]+g[e[t+5]]+"-"+g[e[t+6]]+g[e[t+7]]+"-"+g[e[t+8]]+g[e[t+9]]+"-"+g[e[t+10]]+g[e[t+11]]+g[e[t+12]]+g[e[t+13]]+g[e[t+14]]+g[e[t+15]]).toLowerCase();if(!K(n))throw TypeError("Stringified UUID is invalid");return n}const L=M;function W(e,t,n){e=e||{};var i=e.random||(e.rng||R)();if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,t){n=n||0;for(var s=0;s<16;++s)t[n+s]=i[s];return t}return L(i)}const U=W;var J=Object.defineProperty,q=(e,t,n)=>t in e?J(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,_=(e,t,n)=>(q(e,typeof t!="symbol"?t+"":t,n),n);const l="",V="GitKraken Authentication",S="[GitKraken]";var z=(e=>(e.Off="off",e.Error="error",e.Warn="warn",e.Info="info",e.Debug="debug",e))(z||{}),Q=(e=>(e[e.Off=0]="Off",e[e.Error=1]="Error",e[e.Warn=2]="Warn",e[e.Info=3]="Info",e[e.Debug=4]="Debug",e))(Q||{});const p=class{static configure(e,t){this._isDebugging=e.extensionMode===r.ExtensionMode.Development,this.logLevel=t}static enabled(e){return this.level>=E(e)}static get isDebugging(){return this._isDebugging}static get logLevel(){return this._logLevel}static set logLevel(e){var t;this._logLevel=e,this.level=E(e),e==="off"?((t=this.output)==null||t.dispose(),this.output=void 0):this.output=this.output??r.window.createOutputChannel(V)}static debug(e,...t){this.level<4&&!this.isDebugging||(p.isDebugging&&console.log(this.timestamp,S,e??l,...t),!(this.output==null||this.level<4)&&this.output.appendLine(`${this.timestamp} ${e??l}${this.toLoggableParams(!0,t)}`))}static error(e,t,...n){if(!(this.level<1&&!this.isDebugging)){if(t===void 0){const i=e instanceof Error?e.stack:void 0;if(i){const s=/.*\s*?at\s(.+?)\s/.exec(i);s!==null&&(t=s[1])}}p.isDebugging&&console.error(this.timestamp,S,t??l,...n,e),!(this.output==null||this.level<1)&&this.output.appendLine(`${this.timestamp} ${t??l}${this.toLoggableParams(!1,n)}
${String(e)}`)}}static log(e,...t){this.level<3&&!this.isDebugging||(p.isDebugging&&console.log(this.timestamp,S,e??l,...t),!(this.output==null||this.level<3)&&this.output.appendLine(`${this.timestamp} ${e??l}${this.toLoggableParams(!1,t)}`))}static warn(e,...t){this.level<2&&!this.isDebugging||(p.isDebugging&&console.warn(this.timestamp,S,e??l,...t),!(this.output==null||this.level<2)&&this.output.appendLine(`${this.timestamp} ${e??l}${this.toLoggableParams(!1,t)}`))}static showOutputChannel(){var e;(e=this.output)==null||e.show()}static toLoggable(e,t){if(typeof e!="object")return String(e);if(e instanceof r.Uri)return`Uri(${e.toString(!0)})`;try{return JSON.stringify(e,t)}catch{return"<error>"}}static get timestamp(){return`[${new Date().toISOString().replace(/T/," ").slice(0,-1)}]`}static toLoggableParams(e,t){if(t.length===0||e&&this.level<4&&!p.isDebugging)return l;const n=t.map(i=>this.toLoggable(i)).join(", ");return n.length!==0?` \u2014 ${n}`:l}};let a=p;_(a,"output"),_(a,"_isDebugging"),_(a,"level",0),_(a,"_logLevel","off");function E(e){switch(e){case"off":return 0;case"error":return 1;case"warn":return 2;case"info":return 3;case"debug":return 4;default:return 0}}var X=Object.defineProperty,Y=(e,t,n)=>t in e?X(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,P=(e,t,n)=>(Y(e,typeof t!="symbol"?t+"":t,n),n);const I="gitkraken",Z="GitKraken",k=`${I}.auth`;class tt{constructor(t,n){this.context=t,this.server=n,P(this,"_onDidChangeSessions",new r.EventEmitter),P(this,"_disposable"),P(this,"_sessionsPromise"),this._sessionsPromise=this.getSessionsFromStorage(),this._disposable=r.Disposable.from(r.authentication.registerAuthenticationProvider(I,Z,this,{supportsMultipleAccounts:!1}),this.context.secrets.onDidChange(()=>this.checkForUpdates()))}get onDidChangeSessions(){return this._onDidChangeSessions.event}dispose(){this._disposable.dispose()}async createSession(t){t=t.sort();const n=m(t);a.log(`Creating a session for scopes=${n||"<all>"}...`);try{const i=await this.server.login(t,n),s=await this.createSessionForToken(i,t),o=await this._sessionsPromise,c=o.findIndex(u=>u.id===s.id||m(u.scopes)===n);return c>-1?o.splice(c,1,s):o.push(s),await this.storeSessions(o),this._onDidChangeSessions.fire({added:[s],removed:[],changed:[]}),a.debug(`Created session for scopes=${n||"<all>"}`),s}catch(i){throw i==="Cancelled"||(r.window.showErrorMessage(`Unable to sign in: ${i}`),a.error(i)),i}}async getSessions(t){t=t==null?void 0:t.sort();const n=m(t);a.debug(`Getting sessions for scopes=${n||"all"}...`);const i=await this._sessionsPromise,s=t!=null?i.filter(o=>m(o.scopes)===n):i;return a.debug(`Found ${s.length} sessions for scopes=${n||"<all>"}`),s}async removeSession(t){a.log(`Removing session ${t}...`);try{const n=await this._sessionsPromise,i=n.findIndex(o=>o.id===t);if(i===-1){a.log(`Unable to remove session ${t}; Not found`);return}const s=n[i];n.splice(i,1),await this.storeSessions(n),this._onDidChangeSessions.fire({added:[],removed:[s],changed:[]})}catch(n){throw r.window.showErrorMessage(`Unable to sign out: ${n}`),a.error(n),n}}async checkForUpdates(){const t=await this._sessionsPromise;this._sessionsPromise=this.getSessionsFromStorage();const n=await this._sessionsPromise,i=[],s=[];for(const o of n)t.some(c=>c.id===o.id)||i.push(o);for(const o of t)n.some(c=>c.id===o.id)||s.push(o);(i.length||s.length)&&(a.debug(`Triggering sessions change notifications; added=${i.length}, removed=${s.length}`),this._onDidChangeSessions.fire({added:i,removed:s,changed:[]}))}async createSessionForToken(t,n){const i=await this.server.getAccountInfo(t);return{id:U(),accessToken:t,account:{label:i.accountName,id:i.id},scopes:n}}async getSessionsFromStorage(){let t;try{a.debug("Reading sessions from storage...");const s=await this.context.secrets.get(k);if(!s||s==="[]")return[];a.debug("Found stored sessions");try{t=JSON.parse(s)}catch(o){try{await this.context.secrets.delete(k)}catch{}throw o}}catch(s){return a.error(s,"Unable to read sessions"),[]}const n=t.map(async s=>{var o;const c=m(s.scopes);a.debug(`Read session from storage with scopes=${c}`);let u;if(s.account==null)try{u=await this.server.getAccountInfo(s.accessToken),a.debug(`Verified session with scopes=${c}`)}catch(f){if(f.message==="Unauthorized")return}return{id:s.id,account:{label:s.account!=null?s.account.label??s.account.displayName??"<unknown>":(u==null?void 0:u.accountName)??"<unknown>",id:((o=s.account)==null?void 0:o.id)??(u==null?void 0:u.id)??"<unknown>"},scopes:s.scopes,accessToken:s.accessToken}}),i=(await Promise.allSettled(n)).filter(s=>s.status==="fulfilled").map(s=>s.value).filter(s=>Boolean(s));return a.debug(`Found ${i.length} verified sessions`),i.length!==t.length&&await this.storeSessions(i),i}async storeSessions(t){a.debug(`Storing ${t.length} sessions...`),this._sessionsPromise=Promise.resolve(t),await this.context.secrets.store(k,JSON.stringify(t)),a.debug(`Stored ${t.length} sessions`)}}function m(e){return e==null?void 0:e.join("|")}const et=globalThis.fetch,nt=(e,t)=>t(e);function it(e,t=nt){let n,i;return{promise:new Promise((o,c)=>{n=()=>{n=void 0,c()},i=e(async u=>{try{await t(u,o,c)}catch(f){c(f)}})}).then(o=>(i.dispose(),o),o=>{throw i.dispose(),o}),cancel:()=>n==null?void 0:n()}}function A(e,t){return e===""||t==null?t:t instanceof Error?String(t):t instanceof r.Uri?"sha"in t&&t.sha?`${t.sha}:${t.toString()}`:t.toString():t}function O(...e){if(e.length===0)return"";if(e.length!==1)return JSON.stringify(e,A);const t=e[0];return t==null?"":typeof t=="string"?t:typeof t=="number"||typeof t=="boolean"||t instanceof Error?String(t):t instanceof r.Uri?"sha"in t&&t.sha?`${t.sha}:${t.toString()}`:t.toString():JSON.stringify(t,A)}function st(e,t,...n){if(n.length===0)return e;let i;if(t!=null)try{i=t(...n)}catch{i=O(...n)}else i=O(...n);return`${e}$${i}`}function N(e){return(t,n,i)=>{let s,o;if(typeof i.value=="function")s=i.value,o="value";else if(typeof i.get=="function")s=i.get,o="get";else throw new Error("Not supported");if(s==null)throw new Error("Not supported");const c=`$memoize$${n}`;let u;i[o]=function(...f){const b=st(c,e,...f);return Object.prototype.hasOwnProperty.call(this,b)?(u=this[b],u):(u=s.apply(this,f),Object.defineProperty(this,b,{configurable:!1,enumerable:!1,writable:!1,value:u}),u)}}}var T=Object.defineProperty,rt=Object.getOwnPropertyDescriptor,ot=(e,t,n)=>t in e?T(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,B=(e,t,n,i)=>{for(var s=i>1?void 0:i?rt(t,n):t,o=e.length-1,c;o>=0;o--)(c=e[o])&&(s=(i?c(t,n,s):c(s))||s);return i&&s&&T(t,n,s),s},v=(e,t,n)=>(ot(e,typeof t!="symbol"?t+"":t,n),n);class D{constructor(t,n){this.context=t,this.env=n,v(this,"_deferredCodeExchanges",new Map),v(this,"_disposable"),v(this,"_pendingStates",new Map),v(this,"_statusBarItem"),v(this,"_uriHandler",new at),this._disposable=r.Disposable.from(r.window.registerUriHandler(this._uriHandler))}dispose(){this._disposable.dispose()}get baseApiUri(){return this.env==="staging"?r.Uri.parse("https://stagingapi.gitkraken.com"):this.env==="dev"?r.Uri.parse("https://devapi.gitkraken.com"):r.Uri.parse("https://api.gitkraken.com")}get baseAccountUri(){return this.env==="staging"?r.Uri.parse("https://stagingaccount.gitkraken.com"):this.env==="dev"?r.Uri.parse("https://devaccount.gitkraken.com"):r.Uri.parse("https://account.gitkraken.com")}async getAccountInfo(t){a.debug("Getting account info for token...");let n;try{n=await et(r.Uri.joinPath(this.baseApiUri,"user").toString(),{headers:{Authorization:`Bearer ${t}`,"User-Agent":"Visual-Studio-Code"}})}catch(s){throw a.error(s),s}if(!n.ok)throw a.error(void 0,`Getting account info failed: ${n.statusText}`),new Error(n.statusText);const i=await n.json();return a.debug("Got the account info"),{id:i.id,accountName:i.username}}async login(t,n){a.log(`Logging in for scopes=${n}...`),this.updateStatusBarItem(!0);const i=U(),s=this._pendingStates.get(n)??[];this._pendingStates.set(n,[...s,i]);const o=await r.env.asExternalUri(r.Uri.parse(`${r.env.uriScheme}://${this.context.extension.id}/did-authenticate?gkstate=${i}`)),c=r.Uri.joinPath(this.baseAccountUri,"register").with({query:`${t.includes("gitlens")?"referrer=gitlens&":""}pass-token=true&return-url=${encodeURIComponent(o.toString())}`});await r.env.openExternal(c);let u=this._deferredCodeExchanges.get(n);return u==null&&(u=it(this._uriHandler.event,this.getUriHandlerDeferredExecutor(n)),this._deferredCodeExchanges.set(n,u)),Promise.race([u.promise,new Promise((f,b)=>setTimeout(()=>b("Cancelled"),6e4))]).finally(()=>{this._pendingStates.delete(n),u==null||u.cancel(),this._deferredCodeExchanges.delete(n),this.updateStatusBarItem(!1)})}getUriHandlerDeferredExecutor(t){return(n,i,s)=>{const o=ut(n),c=this._pendingStates.get(t);if(c==null||!c.includes(o.gkstate)){a.log("State not found in accepted state. Skipping this execution...");return}const u=o["access-token"];u==null?s("Token not returned"):i(u)}}updateStatusBarItem(t){t&&this._statusBarItem==null&&(this._statusBarItem=r.window.createStatusBarItem("gitkraken-authentication.signIn",r.StatusBarAlignment.Left),this._statusBarItem.name="GitKraken Sign-in",this._statusBarItem.text="Signing into gitkraken.com...",this._statusBarItem.show()),!t&&this._statusBarItem!=null&&(this._statusBarItem.dispose(),this._statusBarItem=void 0)}}B([N()],D.prototype,"baseApiUri",1),B([N()],D.prototype,"baseAccountUri",1);class at extends r.EventEmitter{handleUri(t){a.log("Handling authentication callback..."),this.fire(t)}}function ut(e){return e.query.split("&").reduce((t,n)=>{const i=n.split("=");return t[i[0]]=i[1],t},{})}var ct=Object.defineProperty,gt=(e,t,n)=>t in e?ct(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,x=(e,t,n)=>(gt(e,typeof t!="symbol"?t+"":t,n),n);const h="gitkraken-authentication";class F{constructor(){x(this,"_onDidChange",new r.EventEmitter),x(this,"_onDidChangeAny",new r.EventEmitter),x(this,"_onWillChange",new r.EventEmitter)}static configure(t){t.subscriptions.push(r.workspace.onDidChangeConfiguration(y.onConfigurationChanged,y))}get onDidChange(){return this._onDidChange.event}get onDidChangeAny(){return this._onDidChangeAny.event}get onWillChange(){return this._onWillChange.event}onConfigurationChanged(t){if(!t.affectsConfiguration(h)){this._onDidChangeAny.fire(t);return}const n={change:t};this._onWillChange.fire(n),n.transform!==void 0&&(t=n.transform(t)),this._onDidChangeAny.fire(t),this._onDidChange.fire(t)}get(t,n,i){return i===void 0?r.workspace.getConfiguration(t===void 0?void 0:h,n).get(t===void 0?h:t):r.workspace.getConfiguration(t===void 0?void 0:h,n).get(t===void 0?h:t,i)}getAny(t,n,i){return i===void 0?r.workspace.getConfiguration(void 0,n).get(t):r.workspace.getConfiguration(void 0,n).get(t,i)}changed(t,n,i){return(t==null?void 0:t.affectsConfiguration(`${h}.${n}`,i))??!0}inspect(t,n){return r.workspace.getConfiguration(t===void 0?void 0:h,n).inspect(t===void 0?h:t)}inspectAny(t,n){return r.workspace.getConfiguration(void 0,n).inspect(t)}name(t){return t}update(t,n,i){return r.workspace.getConfiguration(h).update(t,n,i)}updateAny(t,n,i,s){return r.workspace.getConfiguration(void 0,i===r.ConfigurationTarget.Global?void 0:s).update(t,n,i)}}const y=new F;function lt(e){F.configure(e),a.configure(e,y.get("logLevel"));const t=ht(),n=new D(e,t);e.subscriptions.push(n,new tt(e,n)),a.log(`GitKraken Auth Provider v${e.extension.packageJSON.version} activating in ${r.env.appName}(${r.version}) on the ${r.env.uiKind===r.UIKind.Web?"web":"desktop"}${t!=="production"?`: env: (${t})`:""}`)}function ht(){const e=y.getAny("gitkraken.env");return e==="dev"?"dev":e==="staging"?"staging":"production"}module.exports=$})();
